---
title: "brms test"
author: "Jie Zhao"
date: "October 24, 2017"
output: html_document
---

This is an R Markdown document. the aim is to test the brms library when using regression modeling with prior distribution added in


```{r, echo=F, warning=F, message=F}
library(brms)
nrx_var <- c('prescriptions')
bStd <- T
promo_var <- c("call", "meeting_epu", "meeting_national", "meeting_international", "meeting_other")

model_data_list=readRDS(file = paste0('C:/work/working materials/MCM/R part/Code/Results/2017-10-17 07.22.03/', 'model_data_list.RDS'))

IDs_vct <- model_data_list$mod_data4BaseLine$final_segment
# X4Bayes=model_data_list$X4Bayes
# use data for baseline to do the stan model(the data adding root)
prefix <- "_adj_stk_rt"
X4Bayes <- model_data_list$mod_data4BaseLine[, paste0(promo_var, prefix)]
model_data4BaseLine=model_data_list$mod_data4BaseLine
ctrl_var_inBys <- c('log_trend', 'pos', 'neg', 'pos_77')
# final_segment <- IDs_var
IDs_var <- 'final_segment'

ctrl_var=ctrl_var_inBys
ctrl <- model_data4BaseLine[, ctrl_var]

#       if(bStd){
#             ctrl <- runStd(ctrl_var, ctrl)
#       }
X <- as.matrix(data.frame(X4Bayes, ctrl, final_segment=IDs_vct))
T_mod <- length(unique(model_data4BaseLine$date))
nrx_adj <- paste0(nrx_var, '_adj')

y1 <- model_data4BaseLine[, nrx_adj]
if(bStd){
      y1 <- y1/mean(y1)
}
IDs <- length(unique(model_data4BaseLine[, IDs_var]))

data4brms <- cbind(y1, X)

fix_vars <- c(paste0(promo_var, prefix)
              ,  ctrl_var
)
rnd_vars <- c(paste0(promo_var, prefix), ctrl_var)

library(dplyr)
mu_prec_priors <- data.frame(
      varNm=c(paste0(promo_var, prefix), ctrl_var)
      , mu=c(0.040105695,	0.005538787,	0.012136681,	0.023471172,	0.001431081, 0,0,0,0)
      , prec=c(1061.49395,	125222.6303,	26080.28162,	6973.368051,	1875787.238, 0.9604, 0.9604, 0.9604, 0.9604)
      
) %>%
      mutate(vars=1/prec) %>%
      mutate(stdev=vars^0.5) %>%
      mutate(varNm=as.character(varNm))

# %>% 
#       t(.) %>%
#       setNames(., c(promo_var, ctrl_var))
getMu <- function(distri, var, idx1, idx2){
      if(is.character(idx1)){
            return(paste0(distri, "(", mu_prec_priors[match(var, mu_prec_priors$varNm), idx1], ","
                          , mu_prec_priors[match(var, mu_prec_priors$varNm), idx2]
                          , ')'))
            
      }else{
            return(paste0(distri, "(", idx1, ","
                          , mu_prec_priors[match(var, mu_prec_priors$varNm), idx2]
                          , ')'))
            
      }
      
}


```
this the the formula used in brms model, note that there are both fixed and randomized variable.
```{r}
formula4brms <- as.formula(paste0('y1~'
                  , paste0(fix_vars, collapse="+")
                  , '+(1+'
                  , paste0(rnd_vars, collapse = "+")
                  , "|"
                  , IDs_var
                    , ")"
                  )
                  
)
brmsformula(formula4brms)

```

That is the brm model fit process, note that each promo variables is provided one specific prior distribution based on the coefficients we get in baseline modeling:

```{r, echo=T, message=F, warning=F}
brm_fit <- brm(formula = 
                     brmsformula(formula4brms)
               , data = data4brms
               # , family = lognormal()
               , prior =  c(set_prior('normal(0, 1)', class = 'Intercept')
                            , set_prior("cauchy(0, 2.5)", coef = 'Intercept', class='sd', group = IDs_var)
                            
                            , set_prior(getMu('normal', paste0("call", prefix), 'mu', 'stdev'), coef=paste0("call", prefix), class = 'b')
                            , set_prior(getMu('normal', paste0("meeting_epu", prefix), 'mu', 'stdev'), coef=paste0("meeting_epu", prefix), class = 'b')
                            , set_prior(getMu('normal', paste0("meeting_national", prefix), 'mu', 'stdev'), coef=paste0("meeting_national", prefix), class = 'b')
                            , set_prior(getMu('normal', paste0("meeting_international", prefix), 'mu', 'stdev'), coef=paste0("meeting_international", prefix), class = 'b')
                            , set_prior(getMu('normal', paste0("meeting_other", prefix), 'mu', 'stdev'), coef=paste0("meeting_other", prefix), class = 'b')
                            
                            , set_prior(getMu('cauchy', paste0("call", prefix), 'stdev', 2.5), coef=paste0("call", prefix), class='sd', group = IDs_var)
                            , set_prior(getMu('cauchy', paste0("meeting_epu", prefix),  'stdev', 2.5), coef=paste0("meeting_epu", prefix), class='sd', group = IDs_var)
                            , set_prior(getMu('cauchy', paste0("meeting_national", prefix),  'stdev', 2.5), coef=paste0("meeting_national", prefix), class='sd', group = IDs_var)
                            , set_prior(getMu('cauchy', paste0("meeting_international", prefix),  'stdev', 2.5), coef=paste0("meeting_international", prefix), class='sd', group = IDs_var)
                            , set_prior(getMu('cauchy', paste0("meeting_other", prefix),  'stdev', 2.5), coef=paste0("meeting_other", prefix), class='sd', group = IDs_var)
                            
               )
               # , prior = prior_list
               , iter = 2000
               , chains = 3
               , control = list(adapt_delta = 0.96)
)
summary(brm_fit)

fix <- fixef(brm_fit, old = T)
write.csv(fix, "C:\\work\\working materials\\MCM\\R part\\Code\\Results\\2017-10-24 11.09.41\\fixed_from_brm.csv")
rnd <- ranef(brm_fit, old = T)
write.csv(rnd, "C:\\work\\working materials\\MCM\\R part\\Code\\Results\\2017-10-24 11.09.41\\rnd_from_brm.csv")
```

