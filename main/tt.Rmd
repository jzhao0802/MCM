---
title: "brms test"
author: "Jie Zhao"
date: "October 17, 2017"
output: html_document
---

This is an R Markdown document. the aim is to test the brms library when using regression modeling with prior distribution added in


```{r, echo=F, warning=F, message=F}
library(brms)
nrx_var <- c('prescriptions')
bStd <- T
promo_var <- c("call", "meeting_epu", "meeting_national", "meeting_international", "meeting_other")

model_data_list=readRDS(file = paste0('C:/work/working materials/MCM/R part/Code/Results/2017-10-17 07.22.03/', 'model_data_list.RDS'))

IDs_vct <- model_data_list$mod_data4BaseLine$final_segment
X4Bayes=model_data_list$X4Bayes
model_data4BaseLine=model_data_list$mod_data4BaseLine
ctrl_var_inBys <- c('log_trend', 'pos', 'neg', 'pos_77')
# final_segment <- IDs_var
IDs_var <- 'final_segment'

ctrl_var=ctrl_var_inBys
rnd_vars<- ctrl_var
ctrl <- model_data4BaseLine[, ctrl_var]

#       if(bStd){
#             ctrl <- runStd(ctrl_var, ctrl)
#       }
X <- as.matrix(data.frame(X4Bayes, ctrl, final_segment=IDs_vct))
T_mod <- length(unique(model_data4BaseLine$date))
nrx_adj <- paste0(nrx_var, '_adj')

y1 <- model_data4BaseLine[, nrx_adj]
if(bStd){
      y1 <- y1/mean(y1)
}
IDs <- length(unique(model_data4BaseLine[, IDs_var]))

data4brms <- cbind(y1, X)

fix_vars <- paste0(promo_var, '_adj_stk')


```
this the the formula used in brms model, note that there is only fixed variable.
```{r}
formula4brms <- as.formula(paste0('y1~'
                  , paste0(c(fix_vars, ctrl_var_inBys), collapse="+")
                  , '+(1+'
                  , paste0(fix_vars, collapse = "+")
                  , "|"
                  , IDs_var
                    , ")"
                  )
                  )
brmsformula(formula4brms)

```

That is the brm model fit process, note that each promo variables is provided one specific prior distribution based on the coefficients we get in baseline modeling:

```{r, echo=T, message=F, warning=F}
brm_fit <- brm(formula = 
               brmsformula(formula4brms)
               , data = data4brms
               # , family = lognormal()
               , prior =  c(set_prior("normal(0.01, 0.05)", coef="call_adj_stk")
                            , set_prior("normal(0.04, 0.05)", coef="meeting_epu_adj_stk")
                            , set_prior("normal(0.012, 0.05)", coef="meeting_national_adj_stk")
                            , set_prior("normal(0.023, 0.05)", coef="meeting_international_adj_stk")
                            , set_prior("normal(0.001, 0.05)", coef="meeting_other_adj_stk")
               )
               # , prior = prior_list
               , iter = 2000
               , chains = 3
               , control = list(adapt_delta = 0.96)
)
summary(brm_fit)

```

